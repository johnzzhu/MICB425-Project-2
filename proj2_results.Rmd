---
title: ""
author: ""
date: ''
output:
  html_document:
    df_print: paged
    toc: yes
    toc_float:
      collapsed: no
---

# Methods
Analysis was completed in R v3.4.3 [XXX???] using the following packages.
```{r eval=TRUE, message=FALSE, warning=FALSE}
library(tidyverse)
library(cowplot)
```

Taxonomy, abundance, and query data were loaded from "marker_contig_map.tsv" files obtained from TreeSAPP.
```{r message=FALSE}

treesapp.out.dir = "D:/treesapp_out/"

norC.DNA.10m = read_tsv(paste(treesapp.out.dir, "dna/10m/final_outputs/marker_contig_map.tsv", sep="")) %>% 
  select(Tax.DNA.10 = Confident_Taxonomy, Abund.DNA.10 = Abundance, Query)
norC.DNA.100m = read_tsv(paste(treesapp.out.dir, "dna/100m/final_outputs/marker_contig_map.tsv", sep="")) %>% 
  select(Tax.DNA.100 = Confident_Taxonomy, Abund.DNA.100 = Abundance, Query)
norC.DNA.120m = read_tsv(paste(treesapp.out.dir, "dna/120m/final_outputs/marker_contig_map.tsv", sep="")) %>% 
  select(Tax.DNA.120 = Confident_Taxonomy, Abund.DNA.120 = Abundance, Query)
norC.DNA.135m = read_tsv(paste(treesapp.out.dir, "dna/135m/final_outputs/marker_contig_map.tsv", sep="")) %>% 
  select(Tax.DNA.135 = Confident_Taxonomy, Abund.DNA.135 = Abundance, Query)
norC.DNA.150m = read_tsv(paste(treesapp.out.dir, "dna/150m/final_outputs/marker_contig_map.tsv", sep="")) %>% 
  select(Tax.DNA.150 = Confident_Taxonomy, Abund.DNA.150 = Abundance, Query)
norC.DNA.165m = read_tsv(paste(treesapp.out.dir, "dna/165m/final_outputs/marker_contig_map.tsv", sep="")) %>% 
  select(Tax.DNA.165 = Confident_Taxonomy, Abund.DNA.165 = Abundance, Query)
norC.DNA.200m = read_tsv(paste(treesapp.out.dir, "dna/200m/final_outputs/marker_contig_map.tsv", sep="")) %>% 
  select(Tax.DNA.200 = Confident_Taxonomy, Abund.DNA.200 = Abundance, Query)

norC.RNA.10m = read_tsv(paste(treesapp.out.dir, "RNA/10m/final_outputs/marker_contig_map.tsv", sep="")) %>% 
  select(Tax.RNA.10 = Confident_Taxonomy, Abund.RNA.10 = Abundance, Query)
norC.RNA.100m = read_tsv(paste(treesapp.out.dir, "RNA/100m/final_outputs/marker_contig_map.tsv", sep="")) %>% 
  select(Tax.RNA.100 = Confident_Taxonomy, Abund.RNA.100 = Abundance, Query)
norC.RNA.120m = read_tsv(paste(treesapp.out.dir, "RNA/120m/final_outputs/marker_contig_map.tsv", sep="")) %>% 
  select(Tax.RNA.120 = Confident_Taxonomy, Abund.RNA.120 = Abundance, Query)
norC.RNA.135m = read_tsv(paste(treesapp.out.dir, "RNA/135m/final_outputs/marker_contig_map.tsv", sep="")) %>% 
  select(Tax.RNA.135 = Confident_Taxonomy, Abund.RNA.135 = Abundance, Query)
norC.RNA.150m = read_tsv(paste(treesapp.out.dir, "RNA/150m/final_outputs/marker_contig_map.tsv", sep="")) %>% 
  select(Tax.RNA.150 = Confident_Taxonomy, Abund.RNA.150 = Abundance, Query)
norC.RNA.165m = read_tsv(paste(treesapp.out.dir, "RNA/165m/final_outputs/marker_contig_map.tsv", sep="")) %>% 
  select(Tax.RNA.165 = Confident_Taxonomy, Abund.RNA.165 = Abundance, Query)
norC.RNA.200m = read_tsv(paste(treesapp.out.dir, "RNA/200m/final_outputs/marker_contig_map.tsv", sep="")) %>% 
  select(Tax.RNA.200 = Confident_Taxonomy, Abund.RNA.200 = Abundance, Query)
```

Data were combined into a single data frame.
```{r, warning=FALSE}
# Combine the data frames
norC.all = norC.DNA.10m %>% 
  full_join(norC.DNA.100m, by = "Query") %>% 
  full_join(norC.DNA.120m, by = "Query") %>% 
  full_join(norC.DNA.135m, by = "Query") %>% 
  full_join(norC.DNA.150m, by = "Query") %>% 
  full_join(norC.DNA.165m, by = "Query") %>% 
  full_join(norC.DNA.200m, by = "Query") %>% 
  full_join(norC.RNA.10m,  by = "Query") %>% 
  full_join(norC.RNA.100m, by = "Query") %>% 
  full_join(norC.RNA.120m, by = "Query") %>% 
  full_join(norC.RNA.135m, by = "Query") %>% 
  full_join(norC.RNA.150m, by = "Query") %>% 
  full_join(norC.RNA.165m, by = "Query") %>% 
  full_join(norC.RNA.200m, by = "Query") %>% 
# Create a taxonomy variable aggregating all taxonomy columns to fill in any NAs
  mutate(Taxonomy = ifelse(!is.na(Tax.DNA.10), Tax.DNA.10,
                    ifelse(!is.na(Tax.DNA.100), Tax.DNA.100,
                    ifelse(!is.na(Tax.DNA.120), Tax.DNA.120,
                    ifelse(!is.na(Tax.DNA.135), Tax.DNA.135,
                    ifelse(!is.na(Tax.DNA.150), Tax.DNA.150,
                    ifelse(!is.na(Tax.DNA.165), Tax.DNA.165,
                    ifelse(!is.na(Tax.DNA.200), Tax.DNA.200,
                    ifelse(!is.na(Tax.RNA.10), Tax.RNA.10,
                    ifelse(!is.na(Tax.RNA.100), Tax.RNA.100,
                    ifelse(!is.na(Tax.RNA.120), Tax.RNA.120,
                    ifelse(!is.na(Tax.RNA.135), Tax.RNA.135,
                    ifelse(!is.na(Tax.RNA.150), Tax.RNA.150,
                    ifelse(!is.na(Tax.RNA.165), Tax.RNA.165,
                    ifelse(!is.na(Tax.RNA.200), Tax.RNA.200,
                           "unclassified"))))))))))))))) %>% 
# Remove old Tax variables
  select(-starts_with("Tax.")) %>% 
# Gather all the abundance data into 1 column 
  gather("Key", "Abundance", starts_with("Abund")) %>% 
# Turn the Key into Depth and RNA/DNA variables
  separate(Key, c("Key","Type","Depth_m"), by = ".") %>% 
# Remove Key variable and reorder the columns with Queryat the end
  select(Depth_m, Type, Abundance, Taxonomy, Query) %>% 
# Make depth numerical
  mutate(Depth_m = as.numeric(Depth_m)) %>% 
# Separate Taxonomy into columns
  separate(Taxonomy, into = c("Domain", "Phylum", "Class", "Order", "Family", "Genus", "Species"), sep="; ")
```

Note that not all queries could be classified down to the species level, so those cells were filled in with NA.

# Results

## NorC DNA and RNA Abundance with Depth

```{r}
norC.all %>% 

ggplot(aes(x = Type, y = Depth_m)) +
  geom_point(aes(size = Abundance)) +
  scale_y_reverse(lim=c(200,10)) +
  labs(title = "Abundance of the norC gene (DNA vs. RNA) at different depths",
       x = "") +
  theme_classic()


# TODO remove, here because I found the Abundances strange. I don't know how ggplot plots them, because it's not just summing up...
norC.all %>%
  group_by(Depth_m, Type) %>%
  filter(!is.na(Abundance)) %>%
  summarize(Abundance = sum(Abundance)) %>%

ggplot(aes(x = Type, y = Depth_m)) +
  geom_point(aes(size = Abundance)) +
  scale_y_reverse(lim=c(200,10)) +
  labs(title = "Abundance of the norC gene (DNA vs. RNA) at different depths",
       x = "") +
  theme_classic()

```

The abundance of norC differs with depth. For DNA the abundance is increasing with depth until 150m, where it is maximal. Then the abundance abruptly drops at 165m, and then is relatively high again at 200m. For RNA, norC abundance is relatively low up to depth 135m, only slowly increasing. Then the abundance is notably greater at 150m, and maximum RNA abundance is reached at 165m. Then RNA abundance decreases again at 200m.  

The graph shows that the abundance of DNA differs from the abundance of RNA. DNA abundance is notably higher at depths up to depth 150m. DNA abundance is maximal at 150m, where RNA abundance is lower, and RNA abundance is maximal at 165m, where DNA abundance is quite low. 

## What taxa are responsible for your gene of interest? Are they the same with depth? With DNA versus RNA?
```{r fig.width=8, fig.height=8}
norC.all %>% 
# Change NAs to "unclassified" at the level you want to plot
  mutate(Genus = ifelse(is.na(Genus), "unclassified", Genus)) %>% 
  
ggplot(aes(x = Genus, y = Depth_m)) +
# Use an ifelse statement to make 0 values into NAs so that they don't show up on the plot
# Use position_dodge to keep points from overlapping
  geom_point(aes(size = ifelse(Abundance == 0, NA, Abundance), color = Type), position = position_dodge(0.5)) +
  scale_y_reverse(lim=c(200,10)) +
  labs(title = "Abundance of genera with norC (DNA vs. RNA) at different depths") + 
  theme(axis.text.x = element_text(angle = 20, hjust = 1)) +
# Rename legend
  scale_size_continuous(name = "Abundance")
```

Or you could facet the data.
```{r fig.width=9, fig.height=9}
norC.all %>% 
# Change NAs to "unclassified" at the level you want to plot
  mutate(Genus = ifelse(is.na(Genus), "unclassified", Genus)) %>% 
  
ggplot(aes(x = Genus, y = Depth_m)) +
  geom_point(aes(size = ifelse(Abundance == 0, NA, Abundance))) +
  scale_y_reverse(lim=c(200,10)) +
  facet_wrap(~Type) +
  labs(title = "Abundance of genera with norC (DNA vs. RNA) at different depths") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  scale_size_continuous(name = "Abundance")
```

## How does the abundance of your gene of interest relate to nitrogen species in Saanich?

Load in data from project 1 and pull out the geochemical metadata.
```{r}
load("mothur_phyloseq.RData")

metadata = data.frame(mothur@sam_data)
```

Since we are looking at norC here, we will use methane (CH~4~) instead of a nitrogen species. First, we remake our abundance plot and save it as an object, "plot1"
```{r}

plot1 = norC.all %>% 

ggplot(aes(x = Type, y = Depth_m)) +
  geom_point(aes(size = Abundance)) +
  scale_y_reverse(lim=c(200,10))+
  labs(y = "") +
  theme_classic()

# John: I want to use the plot without the Genera (just DNA/RNA) because the x labels don't play well, so this plot ends up being shorter than the other ones which makes the y axis not match up. besides we have the genera breakdown in its own plot already

# plot1 = norC.all %>% 
# # Change NAs to "unclassified" at the level you want to plot
#   mutate(Genus = ifelse(is.na(Genus), "unclassified", Genus)) %>% 
#   
# ggplot(aes(x = Genus, y = Depth_m)) +
#   geom_point(aes(size = ifelse(Abundance == 0, NA, Abundance), color = Type), position = position_dodge(0.5)) +
#   scale_y_reverse(lim=c(200,10)) +
#   labs(y = "") +
#   theme(axis.text.x = element_text(angle = 90)) +
#   scale_size_continuous(name = "Abundance")
```

Then, we make a plot for methane, "plot2".
```{r}
plot_NO3 = metadata %>% 
  # Order the data by depth  
  arrange(Depth_m) %>% 
  ggplot(aes(x = NO3_uM, y = Depth_m)) +
  geom_point() +
  geom_path(aes(group = 1)) +
  scale_y_reverse(lim=c(200,10)) +
  theme_classic() +
  labs(y = "Depth (m)",
       x = "NO3 (uM)")

plot_NO2 = metadata %>% 
  # Order the data by depth  
  arrange(Depth_m) %>% 
  ggplot(aes(x = NO2_uM, y = Depth_m)) +
  geom_point() +
  geom_path(aes(group = 1)) +
  scale_y_reverse(lim=c(200,10)) +
  theme_classic() +
  labs(y = NULL,
       x = "NO2 (uM)")

plot_NH4 = metadata %>% 
  # Order the data by depth  
  arrange(Depth_m) %>% 
  ggplot(aes(x = NH4_uM, y = Depth_m)) +
  geom_point() +
  geom_path(aes(group = 1)) +
  scale_y_reverse(lim=c(200,10)) +
  theme_classic() +
  labs(y = NULL,
       x = "NH4 (uM)")

plot_N2O = metadata %>% 
  # Order the data by depth  
  arrange(Depth_m) %>% 
  ggplot(aes(x = N2O_nM, y = Depth_m)) +
  geom_point() +
  geom_path(aes(group = 1)) +
  scale_y_reverse(lim=c(200,10)) +
  theme_classic() +
  labs(y = NULL,
       x = "N2O (nM)")
```

Finally we use `cowplot` to create a composite figure. We can add panel labels (A, B) and change the relative widths of the plots. We will make the methane plot much skinnier than the abundance plot.
```{r fig.width=8, fig.height=4}
plot_grid(plot_NO3, plot_NO2, plot_N2O, plot_NH4, plot1, 
          labels=c("A", "B", "C", "D", "E"), 
          nrow = 1, 
          rel_widths=c(1,1,1,1,2))
```
